<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº«ä½“äº¤æ¢ çŠ¶æ€</title>
    <style>
        :root {
            --primary: #ff6b9d;
            --accent-purple: #a78bfa;
            --text-main: #2f3545;
            --text-muted: #6f7390;
            --border: #ffe1ec;
            --bg: #ffffff;
            --hover: #fff0f5;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            background: transparent;
            color: var(--text-main);
            font-size: 13px;
        }
        /* Compact Container */
        .compact-container {
            max-width: 100%;
            padding: 2px;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        /* Header: Inline, dense */
        .header-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #fff9fb;
            border-bottom: 1px solid var(--border);
        }
        .header-title {
            font-weight: bold;
            color: var(--primary);
            font-size: 13px;
        }
        .header-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .meta-item { display: flex; gap: 4px; align-items: center; }
        .meta-val { color: var(--text-main); font-weight: 500; }

        /* Tabs: Slimmer */
        .nav-tabs {
            display: flex;
            padding: 4px 8px;
            gap: 4px;
            border-bottom: 1px solid var(--border);
            background: #fff;
        }
        .tab-btn {
            border: none;
            background: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .tab-btn:hover { background: var(--hover); color: var(--primary); }
        .tab-btn.active { background: var(--primary); color: #fff; }

        /* Content Area */
        .content-area {
            padding: 0;
            background: #fff;
        }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Sections within panes */
        .section {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
        }
        .section:last-child { border-bottom: none; }
        
        .section-title {
            font-size: 11px;
            font-weight: bold;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Character List: Compact rows */
        .char-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border);
        }
        .char-row:last-child { border-bottom: none; padding-bottom: 0; }
        .char-row:first-child { padding-top: 0; }
        
        .char-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .char-name {
            font-weight: bold;
            color: var(--primary);
            font-size: 13px;
        }
        .char-detail {
            display: grid;
            grid-template-columns: 48px 1fr;
            gap: 4px 8px;
            font-size: 12px;
            line-height: 1.4;
        }
        .label { color: var(--text-muted); text-align: justify; text-align-last: justify; }
        .text { color: #444; word-break: break-word; }

        /* Affection Bar: Slim */
        .stat-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }
        .stat-name { font-size: 12px; color: var(--text-main); width: 48px; text-align: justify; text-align-last: justify;}
        .stat-val { font-weight: bold; color: var(--primary); font-size: 12px; min-width: 24px; text-align: right;}
        .progress-track {
            flex: 1;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent-purple));
            transition: width 0.4s ease;
        }

        /* Memory List: Bullet points */
        .mem-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .mem-item {
            position: relative;
            padding-left: 14px;
            font-size: 12px;
            line-height: 1.4;
            color: #555;
        }
        .mem-item::before {
            content: "â™¥";
            color: var(--primary);
            position: absolute;
            left: 0;
            top: 1px;
            font-size: 10px;
        }
        .mem-key {
            font-weight: bold;
            color: var(--text-main);
            margin-right: 4px;
        }

        /* Utils */
        .empty { font-style: italic; color: #999; font-size: 12px; padding: 4px 0; text-align: center;}
        .error-tip { color: #b83232; font-size: 12px; padding: 8px; background: #ffe9e9; border-radius: 4px; }

        /* Load More Button */
        .load-more-btn {
            display: block;
            width: 100%;
            margin-top: 8px;
            padding: 6px 12px;
            background: var(--hover);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .load-more-btn:hover {
            background: var(--primary);
            color: #fff;
        }
        .load-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div class="compact-container" id="app">
    <!-- Header -->
    <header class="header-bar">
        <div class="header-title">èº«ä½“äº¤æ¢æ—¥å¸¸</div>
        <div class="header-meta">
            <div class="meta-item" title="æ—¶é—´">
                <span>ğŸ•’</span><span class="meta-val" id="time">--</span>
            </div>
            <div class="meta-item" title="åœ°ç‚¹">
                <span>ğŸ“</span><span class="meta-val" id="location">--</span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-tabs">
        <button class="tab-btn active" onclick="setTab('chars', this)">å½“å‰è§’è‰²</button>
        <button class="tab-btn" onclick="setTab('sakura', this)">ç™½é¸Ÿæ¨±</button>
    </nav>

    <!-- Content -->
    <div class="content-area">
        <!-- Characters Tab -->
        <div id="tab-chars" class="tab-pane active">
            <div class="section">
                <div id="char-container"></div>
            </div>
        </div>

        <!-- Sakura Tab -->
        <div id="tab-sakura" class="tab-pane">
            <div class="section">
                <div class="stat-row">
                    <div class="stat-name">å¥½æ„Ÿåº¦</div>
                    <div class="progress-track">
                        <div id="sakura-bar" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="stat-val" id="sakura-val">0</div>
                </div>
            </div>
            <div class="section">
                <div class="section-title">é‡è¦è®°å¿†</div>
                <div id="memory-container" class="mem-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
    function setTab(tabId, btn) {
        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        // Update panes
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        const pane = document.getElementById('tab-' + tabId);
        if(pane) pane.classList.add('active');
    }

    function SafeGetValue(obj, path, defaultValue = "N/A") {
        let keys = Array.isArray(path) ? path : path.split('.');
        let current = obj;
        for (let i = 0; i < keys.length; i++) {
            if (current === undefined || current === null || typeof current !== 'object' || !current.hasOwnProperty(keys[i])) {
                return defaultValue;
            }
            current = current[keys[i]];
        }
        return (current === undefined || current === null) ? defaultValue : current;
    }

    async function initDisplay() {
        try {
            const messages = await getChatMessages(getCurrentMessageId());
            if (!messages || messages.length === 0 || !messages[0].data) {
                document.getElementById('app').innerHTML = "<div class='error-tip'>æ— æ³•åŠ è½½æ•°æ® (messages empty)</div>";
                return;
            }
            const gameData = messages[0].data;
            const characterData = gameData.stat_data;
            if (!characterData) {
                document.getElementById('app').innerHTML = "<div class='error-tip'>æ— æ³•åŠ è½½æ•°æ® (stat_data missing)</div>";
                return;
            }

            // Basic Info
            document.getElementById('time').innerText = SafeGetValue(characterData, 'ä¸–ç•Œ.å½“å‰æ—¶é—´');
            document.getElementById('location').innerText = SafeGetValue(characterData, 'ä¸–ç•Œ.å½“å‰åœ°ç‚¹');

            // Characters
            const charContainer = document.getElementById('char-container');
            const currentCharacters = characterData['å½“å‰è§’è‰²'];
            if (currentCharacters && typeof currentCharacters === 'object') {
                let html = '';
                for (const charName in currentCharacters) {
                    const char = currentCharacters[charName];
                    html += `
                        <div class="char-row">
                            <div class="char-header">
                                <div class="char-name">${charName}</div>
                            </div>
                            <div class="char-detail">
                                <div class="label">æƒ³æ³•</div>
                                <div class="text">${char['å½“å‰æƒ³æ³•'] || '-'}</div>
                                <div class="label">çŠ¶æ€</div>
                                <div class="text">${char['å½“å‰çŠ¶æ€'] || '-'}</div>
                                <div class="label">ç©¿ç€</div>
                                <div class="text">${char['å½“å‰ç©¿ç€'] || '-'}</div>
                            </div>
                        </div>
                    `;
                }
                charContainer.innerHTML = html || '<div class="empty">æš‚æ— è§’è‰²</div>';
            } else {
                charContainer.innerHTML = '<div class="empty">æš‚æ— è§’è‰²</div>';
            }

            // Sakura Stats
            const affection = parseFloat(SafeGetValue(characterData, 'ç™½é¸Ÿæ¨±.å¥½æ„Ÿåº¦', 0));
            document.getElementById('sakura-val').innerText = affection;
            document.getElementById('sakura-bar').style.width = Math.max(0, Math.min(100, affection)) + '%';

            // Memories
            const memContainer = document.getElementById('memory-container');
            const memories = characterData['ç™½é¸Ÿæ¨±']?.['é‡è¦è®°å¿†'];
            if (memories && typeof memories === 'object') {
                // Convert to array and reverse (newest first)
                const memArray = Object.entries(memories).reverse();
                window.allMemories = memArray;
                window.currentMemIndex = 0;
                renderMemories();
            } else {
                memContainer.innerHTML = '<div class="empty">æš‚æ— è®°å¿†</div>';
            }

        } catch (e) {
            document.getElementById('app').innerHTML = `<div class='error-tip'>åŠ è½½é”™è¯¯: ${e.message}</div>`;
        }
    }

    function renderMemories() {
        const memContainer = document.getElementById('memory-container');
        const memArray = window.allMemories || [];
        const index = window.currentMemIndex || 0;

        // Display 5 items at a time
        const itemsToShow = memArray.slice(0, index + 5);
        let html = '';

        itemsToShow.forEach(([key, value]) => {
            html += `
                <li class="mem-item">
                    <span class="mem-key">${key}:</span>
                    ${value}
                </li>
            `;
        });

        // Check if there are more items to load
        if (index + 5 < memArray.length) {
            html += `<button class="load-more-btn" onclick="loadMoreMemories()">åŠ è½½æ›´å¤š (${memArray.length - index - 5}æ¡)</button>`;
        }

        memContainer.innerHTML = html || '<div class="empty">æš‚æ— è®°å¿†</div>';
    }

    function loadMoreMemories() {
        window.currentMemIndex = (window.currentMemIndex || 0) + 5;
        renderMemories();
    }

    document.addEventListener('DOMContentLoaded', initDisplay);
</script>
</body>
</html>