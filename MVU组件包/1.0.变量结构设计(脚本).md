# 模块1.0：变量结构设计（Zod脚本）

## 模块定义

本模块是 MVU 系统的第一步，负责通过 Zod schema 定义变量的结构、类型和验证规则。

**核心功能**：
- 使用 Zod 4.x 定义变量结构
- 提供类型安全和运行时验证
- 支持增量更新和幂等操作
- 为后续的变量初始化和更新提供结构约束

**重要说明**：
- 此模块在传统 MVU 初始化之前执行
- 定义的 schema 将用于验证所有变量更新操作
- 支持复杂的嵌套结构和自定义验证逻辑

---

## 生成任务

根据项目需求，使用 Zod 4.x 定义变量结构的 schema，生成完整的 JavaScript 脚本文件。

---

## Zod Schema 设计规范

### 幂等操作原则

Schema 设计必须支持增量更新，确保：
```
Schema.parse(Schema.parse(input)) === Schema.parse(input)
```

**要点**：
- 谨慎使用 `z.transform`，避免破坏幂等性
- 确保 schema 的输出可以作为自身的有效输入

---

### 类型定义规则

#### 数字类型

**优先使用** `z.coerce.number()`：
```js
// 推荐：自动转换字符串数字
好感度: z.coerce.number()

// 不推荐：无法处理字符串输入
好感度: z.number()
```

**注意**：仅对数字使用 `z.coerce.xxx()`，其他类型直接使用基础类型（如 `z.boolean()`、`z.string()`）

---

#### 对象结构优于数组

**推荐方式**（使用 record）：
```js
物品栏: z.record(
  z.string().describe('物品名'),
  z.object({
    描述: z.string(),
    数量: z.coerce.number()
  })
)
```

**不推荐**（使用 array）：
```js
物品栏: z.array(z.object({
  名称: z.string(),
  描述: z.string(),
  数量: z.coerce.number()
}))
```

**原因**：数组索引难以理解和维护，使用对象键（如物品名）更直观

---

#### 对象 Schema 的选择策略

根据对象的键特征选择合适的 schema 类型：

**1. 固定必需键 + 不同类型**
```js
z.object({
  key1: z.string(),
  key2: z.coerce.number(),
  ...
})
```

**2. 固定必需键 + 相同类型**
```js
z.record(
  z.enum(['key1', 'key2', ...]),
  z.string()  // 统一的值类型
)
```

**3. 动态可选键 + 相同类型**
```js
z.record(z.string(), z.coerce.number())
```

**4. 部分必需键 + 动态可选键 + 相同类型**
```js
z.intersection(
  z.object({
    requiredKey1: z.string(),
    requiredKey2: z.coerce.number()
  }),
  z.record(z.string(), z.string())
)
```

---

#### 可清除对象的处理

对于可能被 JSON patch 清除的对象（`{ "op": "remove", "path": "/path/to/object" }`）：

**推荐**：
```js
z.object({ ... }).prefault({})
```

**不推荐**：
```js
z.object({ ... }).optional()
```

**原因**：`.prefault({})` 对增量更新兼容性更好

---

### 约束与验证规则

#### 容错优先原则

当接收到违反 schema 的更新时，优先使用 `z.transform` 进行修正，而非直接拒绝：

**推荐方式**（自动修正）：
```js
// 值限制在 0-100 之间
好感度: z.coerce.number().transform(value => _.clamp(value, 0, 100))

// 对象键数量限制：超出时删除最旧的键
记忆: z.record(z.string(), z.string()).transform(obj => {
  const entries = Object.entries(obj);
  if (entries.length > 10) {
    return Object.fromEntries(entries.slice(-10));
  }
  return obj;
})
```

**不推荐**（直接拒绝）：
```js
好感度: z.number().min(0).max(100)  // 会抛出错误
```

**重要**：仅在 Explorer（用户）明确要求时才施加这些约束

---

### 默认值设置

#### 使用 prefault 而非 default

**推荐**：
```js
z.string().prefault("默认值")
```

**不推荐**：
```js
z.string().default("默认值")
```

**重要**：除非 Explorer 明确要求，否则不要设置任何默认值或施加任何约束

---

## 标准输出格式

### 脚本模板

```js
import { registerMvuSchema } from 'https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/util/mvu_zod.js';

export const Schema = z.object({
  // 在此定义你的变量结构
  日期: z.string(),
  时间: z.string(),
  user: z.object({
    身份: z.string(),
    当前位置: z.string(),
    好感度: z.coerce.number().transform(v => _.clamp(v, -100, 100))
  }),
  // ... 其他变量
});

$(() => {
  registerMvuSchema(Schema);
})
```

---

## 示例参考

**注意**：以下示例仅供参考，实际应根据项目需求定义变量结构。

```js
import { registerMvuSchema } from 'https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/util/mvu_zod.js';

export const Schema = z.object({
  日期: z.string(),
  时间: z.string(),

  user: z.object({
    身份: z.string(),
    当前位置: z.string(),
    重要经历: z.string(),
    好感度: z.coerce.number().transform(v => _.clamp(v, -100, 100))
  }),

  理: z.object({
    当前位置: z.string(),
    情绪状态: z.object({
      pleasure: z.coerce.number().transform(v => _.clamp(v, -1, 1)),
      arousal: z.coerce.number().transform(v => _.clamp(v, -1, 1))
    }),
    当前所想: z.string()
  }),

  世界: z.object({
    当前事件阶段: z.coerce.number(),
    天气: z.string()
  }),

  物品栏: z.record(
    z.string().describe('物品名'),
    z.object({
      描述: z.string(),
      数量: z.coerce.number()
    })
  ).prefault({})
});

$(() => {
  registerMvuSchema(Schema);
})
```

**说明**：
- `好感度` 和 `pleasure`/`arousal` 使用了 `transform` 自动限制范围
- `物品栏` 使用 `record` 而非数组，便于通过物品名访问
- `物品栏` 使用 `prefault({})` 表示可以被清空

---

## 输出要求

### 1. 主体内容

生成完整的 JavaScript 脚本文件，包含：
- 必要的 import 语句
- 完整的 Schema 定义
- 注册 schema 的初始化代码

### 2. 设计原则确认

确保生成的 schema：
- 符合幂等操作要求
- 数字类型使用 `z.coerce.number()`
- 优先使用对象而非数组
- 仅在用户明确要求时添加约束和默认值
- 使用 `z.transform` 进行容错处理（如需要）

### 3. 附加说明

生成脚本后，提供以下说明：

#### a. Schema 结构设计

解释 Schema 的整体结构设计思路和关键字段的类型选择理由。

#### b. 验证规则说明

如果使用了特殊的验证规则或约束，说明其用途和实现方式（如 transform 的作用）。

#### c. 与其他模块的关系

"此 schema 脚本将用于验证所有变量更新操作，应与模块1.1/1.2（变量初始化）、模块2（变量更新规则）和模块3（变量处理指令集）配合使用。"

---

## 生成指令

生成内容后，使用 Write 工具将脚本代码保存到 `变量结构.js` 文件中。

---

## 使用说明

### 与其他模块的关系

- **模块1.1/1.2**（变量初始化）：使用此 schema 验证初始值
- **模块2**（变量更新规则）：更新规则应符合此 schema 定义
- **模块3**（变量处理指令集）：更新命令会被此 schema 验证

---

## 重要提醒

**约束和默认值**：
- 仅在 Explorer 明确要求时才添加验证约束
- 仅在 Explorer 明确要求时才设置默认值
- 优先使用 `z.transform` 进行容错处理，而非直接拒绝输入

**幂等性检查**：
- 生成 schema 后，确保 `Schema.parse(Schema.parse(data))` 等于 `Schema.parse(data)`
- 特别注意 `z.transform` 的使用，避免多次解析产生不同结果
