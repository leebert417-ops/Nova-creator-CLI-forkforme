# 模块3.1：变量处理指令集生成指令

## 模块定义

本模块负责生成一套标准的"变量处理指令集"。该指令集基于模块1（变量初始化）和模块2（变量更新规则），用于指导 AI 系统如何观察、分析并请求更新当前上下文中的动态变量。

**目标**：生成指令结构本身，而非执行变量更新

**更新命令格式**：使用 **JSON Patch (RFC 6902)** 标准

**前置依赖**：
- 模块1.0（变量结构设计脚本）- 提供 Zod Schema 定义
- 模块1.1（变量初始化）- 提供变量初始值
- 模块2（变量更新规则）- 提供更新逻辑

---

## 生成任务

读取前置模块生成的文件，基于其内容输出完整的指令集。

**操作步骤**：
1. 使用 Read 工具读取 `变量结构.js` 文件（了解变量结构）
2. 使用 Read 工具读取 `变量初始化.yaml` 文件（获取初始值示例）
3. 使用 Read 工具读取 `变量更新规则.yaml` 文件（引用更新规则）
4. 基于以上内容生成指令集

---

## 指令集模板

```yaml
---
<status_current_variables>
{{format_message_variable::stat_data}}
</status_current_variables>
rule:
  - You should output the update analysis and the actual update commands in the end of the next reply
  - The update commands must strictly follow the **JSON Patch (RFC 6902)** standard; that is, the output must be a valid JSON array containing operation objects
format: |-
  <UpdateVariable>
  <Analysis>$(IN ENGLISH, no more than 80 words)
  - ${calculate time passed: ...}
  - ${decide whether dramatic updates are allowed as it's in a special case or the time passed is more than usual: yes/no}
  - ${analyze every variable based on its corresponding `check`, according only to current reply instead of previous plots: ...}
  </Analysis>
  <JSONPatch>
  [
    { "op": "replace", "path": "${/path/to/variable}", "value": "${new_value}" },
    { "op": "add", "path": "${/path/to/array/-}", "value": "${item_to_append}" },
    { "op": "add", "path": "${/path/to/object/newKey}", "value": "${content}" }
    { "op": "move", "from": "${/source/list/0}", "path": "${/dest/list/-}" },
    { "op": "remove", "path": "${/path/to/array/0}" },
    ...
  ]
  </JSONPatch>
  </UpdateVariable>
```

---

## JSON Patch 操作说明

JSON Patch (RFC 6902) 是标准的 JSON 文档修改格式，MVU Zod 使用它来更新变量。

### 基本操作类型

1. **`replace`** - 替换现有值
   ```json
   { "op": "replace", "path": "/络络/亲密度", "value": 10 }
   ```

2. **`add`** - 添加新项
   - 向数组末尾添加：`"path": "/记忆/-"`
   - 向对象添加键：`"path": "/物品栏/新物品"`
   ```json
   { "op": "add", "path": "/记忆/-", "value": "重要的一天" }
   { "op": "add", "path": "/物品栏/钥匙", "value": {"数量": 1} }
   ```

3. **`remove`** - 删除项
   ```json
   { "op": "remove", "path": "/记忆/0" }
   ```

4. **`move`** - 移动项
   ```json
   { "op": "move", "from": "/源列表/0", "path": "/目标列表/-" }
   ```

### 路径格式

- 使用 `/` 分隔路径
- 数组索引用数字：`/记忆/0`
- 数组末尾用 `-`：`/记忆/-`
- 对象键直接使用：`/络络/亲密度`

---

## 输出要求

### 1. 读取前置文件

首先读取以下文件（如果不存在，提示用户先完成相应模块）：
- `变量结构.js` - 了解变量结构
- `变量初始化.yaml` - 获取变量示例
- `变量更新规则.yaml` - 引用更新规则

### 2. 结构一致性

最终输出必须与上述模板的结构和格式完全一致。

### 3. 格式说明

**Analysis 部分**：
- 使用英文
- 不超过 80 个单词
- 包含时间计算、是否允许剧烈更新、变量分析

**JSONPatch 部分**：
- 必须是有效的 JSON 数组
- 每个操作对象必须包含 `op` 和 `path`
- `value` 的类型要与变量类型匹配（数字、字符串、对象、数组等）
- 路径使用 `/` 分隔，符合 JSON Pointer 规范

### 4. 附加说明

生成指令集后，提供以下说明：

#### a. 系统集成

"该指令集整合了模块1.0（变量结构脚本）、模块1.1（变量初始化）和模块2（变量更新规则），为 AI 提供完整的变量操作指导，是 MVU Zod 系统运行的核心组件。"

#### b. 更新命令格式

"本系统使用 JSON Patch (RFC 6902) 标准进行变量更新，支持 replace、add、remove、move 等操作，提供了比传统 _.set 更强大的灵活性。"

#### c. 维护提示

"当前置模块（变量结构、初始化、更新规则）发生变化时，需要重新生成此指令集以保持系统一致性。"

---

## 生成指令

生成内容后，使用 Write 工具将指令集内容保存到 `变量处理指令集.yaml` 文件中。

---

## 重要提醒

- **读取文件**：必须先读取前置模块生成的文件
- **JSON Patch 标准**：严格遵循 RFC 6902 规范
- **路径格式**：使用 `/` 分隔，数组末尾用 `-`
- **类型正确**：确保 `value` 的类型与变量类型匹配
