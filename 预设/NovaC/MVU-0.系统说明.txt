### MVU系统：动态内容生成框架说明

本文档旨在介绍MVU（Magical Variable Update）系统，这是一个用于在内容创作中实现角色和世界动态性与成长性的强大框架。该系统使角色和世界能够根据故事进展和状态变化，展现出不同的行为模式和信息反馈。

理解MVU系统的主要构成部分，对于高效地利用它至关重要。一个典型的MVU系统实现，通常包含以下几个核心组件（常表现为世界书条目或逻辑模块）：

## 系统构成模块

### 1. 变量初始化条目 (`[InitVar]`)
   - 作用：定义系统中所有动态变量的初始值
   - 格式：JSON5格式，采用简洁的键值对结构
   - 内容：仅包含变量名和对应的初始值，不包含更新规则
   - 存储：变量值存储在特定宏（如 `stat_data`）中，供后续脚本访问
   - 命名约定：世界书条目名称包含 `[InitVar]` 标记
   - 版本：提供稳定版与Beta版两种用法
     - 稳定版（见《1.1.变量初始化条目.md》）：纯数据初始化，不包含结构约束元信息；数组与对象的结构默认锁定。
     - Beta版（见《1.2.变量初始化条目beta.md》）：在初始化数据中可添加结构约束元信息，用于生成“模式”并启用结构变更校验。

### 2. 变量更新规则定义
   - 作用：独立定义每个变量的更新逻辑和约束条件
   - 格式：YAML格式，结构化描述变量行为
   - 内容：包含变量类型(type)、取值范围(range)和检查条件(check)
   - 优势：与初始化分离，便于维护和修改更新逻辑
   - 引用：被变量处理指令集调用，为AI提供更新指导

### 3. 变量处理指令集
   - 作用：向AI展示变量状态并提供标准化的更新指令格式
   - 核心内容：
     - 显示当前所有变量的状态值
     - 引用变量更新规则，指导AI判断更新时机
     - 规定标准的输出格式，包含分析过程和更新命令
   - 目的：确保AI能够正确感知变量状态并按规范输出更新指令

   - 版本：提供稳定版与Beta版两种用法
     - 稳定版（见《3.1.变量处理指令集.md》）：使用 `_.set` 基本更新能力。
     - Beta版（见《3.2.变量处理指令集beta.md》）：新增 `_.add`、`_.assign`、`_.remove` 等增强命令，并与“数据结构安全”的模式校验配合使用。

### 4. 分阶段角色设定
   - 作用：根据变量值动态调整角色行为和表现
   - 实现方式：使用EJS条件判断，基于变量状态选择不同的角色设定
   - 应用场景：好感度变化、故事进展、情绪状态等触发的角色行为差异
   - 灵活性：可扩展到任何需要根据变量动态变化的内容

### 5. HTML状态展示
   - 作用：为用户提供直观的变量状态可视化界面
   - 功能：实时显示重要变量的当前值和变化趋势
   - 用户体验：增强沉浸感，让用户了解系统状态

## 系统工作流程

MVU系统的完整工作流程包含以下5个阶段：

1. 变量定义与初始化 - 确定需要追踪的动态变量并设置初始值
2. 更新规则设计 - 为每个变量定义类型、范围和更新条件
3. 指令集配置 - 建立AI感知变量状态和输出更新指令的机制
4. 角色阶段设定 - 基于变量值配置动态角色行为
5. 状态可视化 - 为用户提供直观的系统状态展示

## 系统优势

- 模块化设计：各组件职责清晰，便于独立维护和扩展
- 关注点分离：初始化、更新规则、展示逻辑相互独立
- 高度可配置：支持复杂的变量依赖关系和条件逻辑
- 用户友好：提供直观的状态反馈和可视化界面

后续的功能模块将基于此框架进行构建与扩展。理解此核心框架是高效协作的基础。当前仅需理解该系统概念，无需执行具体操作。

## 数据结构安全（Beta）

为防止LLM误用 `assign`/`remove` 导致结构破坏（例如误删关键字段、向对象添加不允许的键、或清空整个对象/数组），Beta版引入“模式校验保护机制”。

- 定义位置：在 `[InitVar]` 的JSON数据中，为对象添加特殊键 `"$meta"` 描述对象层的结构规则；为数组在任意位置添加特殊字符串 `"$__META_EXTENSIBLE__$"` 声明该数组结构可扩展。
- 生效方式：在世界书初始化及每次结构变动后，系统会从当前 `stat_data` 生成一个“模式（schema）”。LLM执行 `_.assign`/`_.remove` 等结构性变更命令时，将对照该模式进行校验，拦截未授权的结构变更。
- 清理策略：初始化完成后，所有 `"$meta"` 与 `"$__META_EXTENSIBLE__$"` 元信息会被移除，不会出现在后续的 `stat_data` 中，避免浪费token与注意力。

### 对象元信息：`"$meta"`

`"$meta"` 接受以下属性，用于声明对象的结构策略：

- `"extensible"`（默认 `false`）
  - `false`：对象结构锁定，禁止添加/删除键。
  - `true`：对象结构开放，允许通过 `_.assign` 添加新键、通过 `_.remove` 删除键。开启后该层子元素默认视为非必需，除非在 `required` 中另行指定。
- `"required"`: `string[]`
  - 列表中的键为必需项，禁止被 `_.remove` 删除。若不填写，则必需性取决于 `extensible` 策略。
- `"recursiveExtensible"`: `boolean`（默认 `false`）
  - 为 `true` 时，表示本对象的所有子孙对象均可扩展（穿透生效），直至遇到某层明确设置 `"extensible": false` 才停止。
  - 在当前层面，`"recursiveExtensible": true` 等效于 `"extensible": true`。
- `"template"`: `object | array`
  - 当使用 `_.assign` 新增结构（对象或数组项）时，将与该模板进行深度合并，以便自动补齐必要的子结构。

说明：`"$meta"` 键完全可以不写，系统会采用默认值（对象锁定、非递归扩展、无必需项、空模板）。

### 数组可扩展标记：`"$__META_EXTENSIBLE__$"`

- 默认情况下所有数组结构均为锁定。若在数组任意位置放置特殊字符串 `"$__META_EXTENSIBLE__$"`，则该数组结构视为可扩展，允许 `_.assign`/`_.remove` 对其进行增删项；初始化完成后该字符串将自动移除。

### 示例（节选）

```json5
{
  "人物": {
    "$meta": {
      "extensible": false,
      "required": ["姓名", "属性"],
      "template": {
        "属性": {"力量": 0, "敏捷": 0, "智力": 0}
      }
    },
    "姓名": "白夭夭",
    "属性": {
      "$meta": {
        "extensible": true,
        "required": ["力量", "敏捷", "智力"]
      },
      "力量": 3,
      "敏捷": 4,
      "智力": 5
    }
  },
  "记忆": [
    "$__META_EXTENSIBLE__$",
    "雨中初遇"
  ]
}
```

### 使用建议与兼容性

- 若项目使用MVU Beta运行时（例如通过加载 Beta 脚本包），可在 `[InitVar]` 中使用上述元信息以获得结构保护；若使用稳定版运行时，请勿加入这些元信息，以免被当作普通数据保存。
- 设计规则时优先为根对象与关键子对象定义 `"$meta"`，仅对确需动态增删的数组添加 `"$__META_EXTENSIBLE__$"`，其余保持锁定有助于稳定性。
